# =====================================================
# Yemekte Balık Var - .htaccess FINAL VERSION
# https://yemektebalikvar.com
# SEO + Performance + Security + Traffic Optimization
# =====================================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    
    # -----------------------------------------------------
    # 1. HTTPS + NON-WWW ZORUNLU
    # -----------------------------------------------------
    RewriteCond %{HTTPS} off
    RewriteCond %{HTTP:X-Forwarded-Proto} !https
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
    RewriteRule ^(.*)$ https://%1/$1 [R=301,L]
    
    # -----------------------------------------------------
    # 2. TRAILING SLASH KALDIR
    # -----------------------------------------------------
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]
    
    # -----------------------------------------------------
    # 3. ÖZEL DOSYALAR (sitemap, robots)
    # -----------------------------------------------------
    RewriteRule ^sitemap\.xml$ sitemap.php [L]
    RewriteRule ^robots\.txt$ robots.php [L]
    
    # -----------------------------------------------------
    # 4. SEO-FRIENDLY URL YAPILAR (YENİ SİTE)
    # Bu kurallar ÖNCE gelmeli - yoksa 404'e düşer
    # -----------------------------------------------------
    
    # Tarif detay: /tarif/[slug]
    RewriteRule ^tarif/([a-z0-9-]+)/?$ pages/tarif-detay.php?slug=$1 [L,QSA]
    
    # ESKİ URL'den YENİ URL'e redirect (Google için)
    RewriteCond %{QUERY_STRING} ^slug=([a-z0-9-]+)$
    RewriteRule ^pages/tarif-detay\.php$ /tarif/%1? [R=301,L]
    
    # Blog detay: /blog/[slug]
    RewriteRule ^blog/([a-z0-9-]+)/?$ pages/blog-detay.php?slug=$1 [L,QSA]
    
    # Ürün detay: /urun/[slug]
    RewriteRule ^urun/([a-z0-9-]+)/?$ pages/urun-detay.php?slug=$1 [L,QSA]
    
    # Community: /community/[id]
    RewriteRule ^community/([0-9]+)/?$ pages/community-tarif-detay.php?id=$1 [L,QSA]
    
    # Kategori: /kategori/[slug]
    RewriteRule ^kategori/([a-z0-9-]+)/?$ pages/tarifler.php?kategori=$1 [L,QSA]
    
    # -----------------------------------------------------
    # 5. ESKİ URL'LERİ redirect-handler.php'YE YÖNLENDIR
    # SADECE eski yapılar için
    # -----------------------------------------------------
    
    # ESKİ YAPILAR - redirect-handler.php işlesin
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(nasil-saklanir|category|recipe|recipes|post|posts|product|products|tag)/ redirect-handler.php [L]
    
    # -----------------------------------------------------
    # 6. CLEAN URLs - .php uzantısını kaldır
    # -----------------------------------------------------
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME}\.php -f
    RewriteRule ^([^\.]+)$ $1.php [L]
    
    # -----------------------------------------------------
    # 7. DİĞER TÜM 404'LER - pages/404.php
    # redirect-handler.php yerine mevcut 404.php kullanılıyor
    # -----------------------------------------------------
    
</IfModule>

# 404 Error Handler - Mevcut pages/404.php
ErrorDocument 404 /pages/404.php

# -----------------------------------------------------
# GZIP COMPRESSION (Hız Optimizasyonu)
# -----------------------------------------------------
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
    AddOutputFilterByType DEFLATE text/javascript application/javascript application/x-javascript
    AddOutputFilterByType DEFLATE application/json application/xml application/xhtml+xml
    AddOutputFilterByType DEFLATE image/svg+xml
    
    # Font dosyaları
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE font/opentype font/woff font/woff2
    
    # Legacy browser desteği
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    
    Header append Vary User-Agent
</IfModule>

# -----------------------------------------------------
# BROWSER CACHING (Agresif Cache)
# -----------------------------------------------------
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 month"
    
    # HTML - Cache yok (her zaman fresh)
    ExpiresByType text/html "access plus 0 seconds"
    
    # Data - Cache yok
    ExpiresByType application/json "access plus 0 seconds"
    ExpiresByType application/xml "access plus 0 seconds"
    
    # Favicon (1 yıl)
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType image/vnd.microsoft.icon "access plus 1 year"
    
    # Resimler (1 yıl)
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    
    # Fontlar (1 yıl)
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    
    # CSS ve JavaScript (1 yıl)
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
    
    # Video (1 ay)
    ExpiresByType video/mp4 "access plus 1 month"
    ExpiresByType video/webm "access plus 1 month"
</IfModule>

# -----------------------------------------------------
# CACHE CONTROL HEADERS
# -----------------------------------------------------
<IfModule mod_headers.c>
    # Static dosyalar için agresif cache
    <FilesMatch "\.(ico|pdf|jpg|jpeg|png|gif|webp|svg|js|css|woff|woff2|ttf|otf)$">
        Header set Cache-Control "max-age=31536000, public, immutable"
    </FilesMatch>
    
    # HTML/PHP dosyaları cache'lenmesin
    <FilesMatch "\.(html|htm|php)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires 0
    </FilesMatch>
</IfModule>

# -----------------------------------------------------
# SECURITY HEADERS
# -----------------------------------------------------
<IfModule mod_headers.c>
    # XSS Protection
    Header set X-XSS-Protection "1; mode=block"
    
    # Clickjacking önleme
    Header always append X-Frame-Options "SAMEORIGIN"
    
    # MIME Type sniffing önleme
    Header set X-Content-Type-Options "nosniff"
    
    # Referrer Policy (SEO için önemli!)
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # X-Powered-By kaldır (güvenlik)
    Header unset X-Powered-By
    Header unset Server
    
    # HSTS (HTTPS zorunlu - 1 yıl)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" env=HTTPS
    
    # Permissions Policy
    Header set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# -----------------------------------------------------
# ETAG OPTIMIZATION
# -----------------------------------------------------
<IfModule mod_headers.c>
    FileETag MTime Size
    
    <FilesMatch "\.(js|css|xml|gz|html)$">
        Header append Vary: Accept-Encoding
    </FilesMatch>
</IfModule>

# -----------------------------------------------------
# MIME TYPES
# -----------------------------------------------------
<IfModule mod_mime.c>
    # Font types
    AddType application/font-woff2 .woff2
    AddType application/font-woff .woff
    AddType application/vnd.ms-fontobject .eot
    AddType font/ttf .ttf
    AddType font/otf .otf
    
    # Image types
    AddType image/webp .webp
    AddType image/svg+xml .svg .svgz
    AddType image/avif .avif
    
    # JavaScript
    AddType application/javascript .js .mjs
    AddType application/json .json
    
    # Video
    AddType video/mp4 .mp4 .m4v
    AddType video/webm .webm
    
    # Compression
    AddEncoding gzip .gz .gzip
</IfModule>

# -----------------------------------------------------
# DISABLE DIRECTORY BROWSING
# -----------------------------------------------------
Options -Indexes
Options -MultiViews

# -----------------------------------------------------
# PROTECT SENSITIVE FILES
# -----------------------------------------------------

# Config dosyalarını koru
<FilesMatch "^(config|database|functions|seo|redirect-handler)\.php$">
    <IfModule mod_authz_core.c>
        Require all granted
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Allow from all
    </IfModule>
</FilesMatch>

# .htaccess'i koru
<Files .htaccess>
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</Files>

# Hidden files (.git, .env, .svn)
<FilesMatch "^\.">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>

# Backup ve log dosyalarını koru
<FilesMatch "\.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>

# -----------------------------------------------------
# PHP SETTINGS
# -----------------------------------------------------
<IfModule mod_php7.c>
    # Hata gösterimi kapat (production)
    php_flag display_errors Off
    php_flag display_startup_errors Off
    
    # Error log'a kaydet
    php_flag log_errors On
    
    # Upload limitleri
    php_value upload_max_filesize 10M
    php_value post_max_size 12M
    php_value max_execution_time 300
    php_value max_input_time 300
    
    # Memory limit
    php_value memory_limit 256M
    
    # Session güvenliği
    php_flag session.cookie_httponly On
    php_value session.cookie_samesite Lax
    
    # Timezone
    php_value date.timezone "Europe/Istanbul"
    
    # Output compression
    php_flag zlib.output_compression On
</IfModule>

# -----------------------------------------------------
# CHARSET
# -----------------------------------------------------
AddDefaultCharset UTF-8
<IfModule mod_mime.c>
    AddCharset utf-8 .html .css .js .xml .json .rss .atom
</IfModule>

# -----------------------------------------------------
# BLOCK BAD BOTS
# -----------------------------------------------------
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
    RewriteCond %{HTTP_USER_AGENT} (AhrefsBot|SemrushBot|MJ12bot|DotBot|BLEXBot|Bytespider|GPTBot|CCBot|anthropic-ai|PetalBot|Serpstatbot) [NC]
    RewriteRule .* - [F,L]
</IfModule>

# -----------------------------------------------------
# PREVENT IMAGE HOTLINKING
# -----------------------------------------------------
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?yemektebalikvar\.com [NC]
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?google\. [NC]
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?bing\. [NC]
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?facebook\. [NC]
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?instagram\. [NC]
    RewriteCond %{REQUEST_URI} !^/assets/images/logo\.png$ [NC]
    RewriteRule \.(jpg|jpeg|png|gif|webp)$ - [F,NC,L]
</IfModule>

# =====================================================
# SON - Yemekte Balık Var
# Ultimate SEO + Performance + Traffic Optimization
# Son Güncelleme: 2025-01-15
# =====================================================